<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ü—Ä–æ—Å–ª—É—à–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; color:#111; }
h1,h2 { margin:0 0 12px 0; }
.container { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
.grid { display:flex; gap:16px; align-items:flex-start; }
.form-section { flex:1; min-width:260px; }
.table-section { flex:2; min-width:420px; }
label { display:block; margin-top:10px; font-size:13px; }
input[type="text"], textarea, input[type="date"] {
  width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #d0d0d0; border-radius:4px;
}
textarea { min-height:60px; resize:vertical; }
button { padding:8px 12px; margin-top:10px; cursor:pointer; border-radius:6px; border:1px solid #bbb; background:#f6f6f6; }
button.primary { background:#2b8aef; color:white; border-color:#2577d4; }
button.danger { background:#ffdddd; border-color:#ff8a8a; }
button.small { padding:6px 8px; font-size:13px; }
table { width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
th, td { border:1px solid #e0e0e0; padding:8px; vertical-align:top; text-align:left; background:#fff; }
th { background:#f0f0f0; font-weight:600; }
.spoiler { margin-top:12px; }
.hidden { display:none; }
.controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.muted { color:#666; font-size:13px; }
</style>
</head>
<body>

<div class="grid">
  <div class="container form-section">
    <h1>–§–æ—Ä–º–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</h1>

    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—É—á–∞—é—â–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label>
    <input type="text" id="eventName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">

    <label>–¶–ê:</label>
    <input type="text" id="targetAudience" placeholder="–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è">

    <label>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:</label>
    <textarea id="growthZones" placeholder="–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞..."></textarea>

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>

    <label>–£—á–∞—Å—Ç–Ω–∏–∫:</label>
    <input type="text" id="participant" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞">

    <div class="controls">
      <button id="saveBtn" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="updateBtn" class="primary hidden">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button id="cancelBtn" class="small hidden">–û—Ç–º–µ–Ω–∞</button>
      <button id="uploadSheetsBtn" class="small" style="margin-left:auto;">üì§ Google Sheets</button>
    </div>

    <div class="muted" style="margin-top:10px;">
      –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –±—Ä–∞—É–∑–µ—Ä–∞. –í—ã–≥—Ä—É–∑–∫–∞ –≤ Google Sheets –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –ø–æ —Å—Å—ã–ª–∫–µ.
    </div>
  </div>

  <div class="container table-section">
    <h2>–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
    <table id="mainTable">
      <thead>
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–¶–ê</th>
          <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
          <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="spoiler">
      <button id="toggleSpoilerBtn" class="small">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
      <table id="spoilerTable" class="hidden">
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–¶–ê</th>
            <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="container" style="margin-top:16px;">
  <h2>–ê—Ä—Ö–∏–≤ –∑–∞–ø–∏—Å–µ–π</h2>
  <div style="display:flex; align-items:center; gap:8px;">
    <label>–î–∞—Ç–∞:</label>
    <input type="date" id="archiveDate">
    <button class="small" id="prevDateBtn">‚¨Ö</button>
    <button class="small" id="nextDateBtn">‚û°</button>
    <button class="small" id="downloadCSVBtn" style="margin-left:auto;">üì• –°–∫–∞—á–∞—Ç—å CSV</button>
  </div>
  <table id="archiveTable">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞ / –í—Ä–µ–º—è</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–¶–ê</th>
        <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let editIndex = null;

function getRecords() { return JSON.parse(localStorage.getItem('records')||'[]'); }
function setRecords(records) { localStorage.setItem('records',JSON.stringify(records)); }
function getLastUploadedIndex(){ return parseInt(localStorage.getItem('lastUploadedIndex')||'-1'); }
function setLastUploadedIndex(idx){ localStorage.setItem('lastUploadedIndex',idx); }

function escapeHtml(s){ return s?s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'):""; }
function escapeCsv(s){ return s?s.replace(/"/g,'""'):""; }

function refreshAll() { renderMainTable(); renderArchiveTableForSelectedDate(); }

function saveRecord() {
  const eventName=document.getElementById('eventName').value.trim();
  const participant=document.getElementById('participant').value.trim();
  if(!eventName||!participant){alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");return;}
  const records=getRecords();
  records.push({
    date:new Date().toISOString().split('T')[0],
    time:new Date().toLocaleTimeString(),
    eventName,
    targetAudience:document.getElementById('targetAudience').value.trim(),
    growthZones:document.getElementById('growthZones').value.trim(),
    comment:document.getElementById('comment').value.trim(),
    participant
  });
  setRecords(records);
  clearForm();
  showSaveMode();
  refreshAll();
}

function updateRecord() {
  if(editIndex===null) return;
  const records=getRecords();
  const r=records[editIndex];
  r.eventName=document.getElementById('eventName').value.trim();
  r.targetAudience=document.getElementById('targetAudience').value.trim();
  r.growthZones=document.getElementById('growthZones').value.trim();
  r.comment=document.getElementById('comment').value.trim();
  r.participant=document.getElementById('participant').value.trim();
  setRecords(records);
  clearForm();
  showSaveMode();
  refreshAll();
}

function clearForm(){ ["eventName","targetAudience","growthZones","comment","participant"].forEach(id=>document.getElementById(id).value=""); }
function showSaveMode(){ document.getElementById('saveBtn').classList.remove('hidden'); document.getElementById('updateBtn').classList.add('hidden'); document.getElementById('cancelBtn').classList.add('hidden'); editIndex=null; }
function showEditMode(){ document.getElementById('saveBtn').classList.add('hidden'); document.getElementById('updateBtn').classList.remove('hidden'); document.getElementById('cancelBtn').classList.remove('hidden'); }

function rowHtml(r,idx){ return `<tr>
<td>${escapeHtml(r.eventName)}</td>
<td>${escapeHtml(r.targetAudience||'')}</td>
<td>${escapeHtml(r.growthZones||'')}</td>
<td>${escapeHtml(r.comment||'')}</td>
<td>${escapeHtml(r.participant||'')}</td>
<td>
<button class="small" onclick="editRecord(${idx})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="small danger" onclick="deleteRecord(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
</td>
</tr>`; }

function renderMainTable(){
  const records=getRecords();
  const mainBody=document.querySelector('#mainTable tbody');
  const spoilerBody=document.querySelector('#spoilerTable tbody');
  mainBody.innerHTML=''; spoilerBody.innerHTML='';
  if(!records.length){ mainBody.innerHTML='<tr><td colspan="6" class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>'; document.getElementById('toggleSpoilerBtn').classList.add('hidden'); return; }
  mainBody.innerHTML=rowHtml(records[records.length-1],records.length-1);
  if(records.length>1){ document.getElementById('toggleSpoilerBtn').classList.remove('hidden'); for(let i=records.length-2;i>=0;i--) spoilerBody.innerHTML+=rowHtml(records[i],i); }
}

function editRecord(idx){ const r=getRecords()[idx]; document.getElementById('eventName').value=r.eventName; document.getElementById('targetAudience').value=r.targetAudience||''; document.getElementById('growthZones').value=r.growthZones||''; document.getElementById('comment').value=r.comment||''; document.getElementById('participant').value=r.participant||''; editIndex=idx; showEditMode(); }
function deleteRecord(idx){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return; const records=getRecords(); records.splice(idx,1); setRecords(records); if(editIndex===idx) showSaveMode(); refreshAll(); }
function toggleSpoiler(){ const table=document.getElementById('spoilerTable'); const btn=document.getElementById('toggleSpoilerBtn'); table.classList.toggle('hidden'); btn.textContent=table.classList.contains('hidden')?'–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏':'–°–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å–∏'; }

const archiveInput=document.getElementById('archiveDate');
function renderArchiveTableForSelectedDate(){
  const records=getRecords(); const body=document.querySelector('#archiveTable tbody'); const date=archiveInput.value;
  if(!date){body.innerHTML='<tr><td colspan="6" class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>'; return;}
  const filtered=records.filter(r=>r.date===date);
  if(!filtered.length){body.innerHTML='<tr><td colspan="6" class="muted">–ó–∞–ø–∏—Å–µ–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç</td></tr>'; return;}
  body.innerHTML=''; filtered.forEach(r=>{ body.innerHTML+=`<tr>
<td>${escapeHtml(r.date)} ${escapeHtml(r.time||'')}</td>
<td>${escapeHtml(r.eventName)}</td>
<td>${escapeHtml(r.targetAudience||'')}</td>
<td>${escapeHtml(r.growthZones||'')}</td>
<td>${escapeHtml(r.comment||'')}</td>
<td>${escapeHtml(r.participant||'')}</td>
</tr>`; });
}

function prevDate(){ const d=new Date(archiveInput.value); d.setDate(d.getDate()-1); archiveInput.value=d.toISOString().split('T')[0]; renderArchiveTableForSelectedDate(); }
function nextDate(){ const d=new Date(archiveInput.value); d.setDate(d.getDate()+1); archiveInput.value=d.toISOString().split('T')[0]; renderArchiveTableForSelectedDate(); }

document.getElementById('saveBtn').addEventListener('click',saveRecord);
document.getElementById('updateBtn').addEventListener('click',updateRecord);
document.getElementById('cancelBtn').addEventListener('click',()=>{clearForm();showSaveMode();});
document.getElementById('toggleSpoilerBtn').addEventListener('click',toggleSpoiler);
document.getElementById('prevDateBtn').addEventListener('click',prevDate);
document.getElementById('nextDateBtn').addEventListener('click',nextDate);
document.getElementById('downloadCSVBtn').addEventListener('click',()=>{
  const records=getRecords(); if(!records.length){alert('–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç!');return;}
  let csv='–î–∞—Ç–∞;–í—Ä–µ–º—è;–ù–∞–∑–≤–∞–Ω–∏–µ;–¶–ê;–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞;–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π;–£—á–∞—Å—Ç–Ω–∏–∫\n';
  records.forEach(r=>csv+=`"${r.date}";"${r.time||''}";"${escapeCsv(r.eventName)}";"${escapeCsv(r.targetAudience||'')}";"${escapeCsv(r.growthZones||'')}";"${escapeCsv(r.comment||'')}";"${escapeCsv(r.participant||'')}"\n`);
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='–∞—Ä—Ö–∏–≤.csv'; link.click();
});

// ===== Google Sheets upload =====
document.getElementById('uploadSheetsBtn').addEventListener('click',()=>{
  const records=getRecords(); const last=getLastUploadedIndex(); const newRecords=records.slice(last+1);
  if(!newRecords.length){ alert('–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏'); return; }
  const APPS_SCRIPT_URL='–í–ê–®_URL_APPS_SCRIPT'; // –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à URL Web App
  fetch(APPS_SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(newRecords)})
  .then(res=>res.json())
  .then(()=>{ alert(`${newRecords.length} –∑–∞–ø–∏—Å—å(–µ–π) —É—Å–ø–µ—à–Ω–æ –≤—ã–≥—Ä—É–∂–µ–Ω–æ –≤ Google Sheets!`); setLastUploadedIndex(records.length-1); })
  .catch(err=>{ console.error(err); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ'); });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function initArchiveDate(){ const records=getRecords(); if(!records.length) return; const dates=[...new Set(records.map(r=>r.date))].sort(); archiveInput.value=dates[dates.length-1]||new Date().toISOString().split('T')[0]; renderArchiveTableForSelectedDate(); }

window.addEventListener('load',()=>{refreshAll();showSaveMode();initArchiveDate();});
</script>

</body>
</html>





