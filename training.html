<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ—Å–ª—É—à–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ (Firebase + Google Sheets)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
h2 { margin-top: 30px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
th { background: #eaeaea; }
input, textarea { width: 100%; padding: 6px; margin: 4px 0; }
button { padding: 6px 12px; margin-top: 5px; cursor: pointer; }
.container { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.grid { display: flex; gap: 20px; }
.form-section { flex: 1; }
.table-section { flex: 2; }
.spoiler { margin-top: 10px; }
.spoiler button { margin-bottom: 8px; }
.hidden { display: none; }
</style>
</head>
<body>

<div class="grid">
  <div class="container form-section">
    <h1>–§–æ—Ä–º–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</h1>
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—É—á–∞—é—â–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label>
    <input type="text" id="eventName">
    <label>–¶–ê:</label>
    <input type="text" id="targetAudience">
    <label>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:</label>
    <textarea id="growthZones"></textarea>
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="comment"></textarea>
    <label>–£—á–∞—Å—Ç–Ω–∏–∫:</label>
    <input type="text" id="participant">
    <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="uploadToSheetsBtn">–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Google Sheets</button>
  </div>

  <div class="container table-section">
    <h2>–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
    <table id="mainTable">
      <thead>
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–¶–ê</th>
          <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
          <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="spoiler">
      <button id="toggleSpoilerBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
      <table id="spoilerTable" class="hidden">
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–¶–ê</th>
            <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="container">
  <h2>–ê—Ä—Ö–∏–≤ –∑–∞–ø–∏—Å–µ–π</h2>
  <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
  <input type="date" id="archiveDate">
  <button id="prevDateBtn">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
  <button id="nextDateBtn">–°–ª–µ–¥—É—é—â–∞—è ‚û°</button>
  <button id="downloadCSVBtn">üì• –°–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ (Excel/CSV)</button>

  <table id="archiveTable">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–¶–ê</th>
        <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-firestore-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyB5ljqThoa3rS8ZjJD-FpsYjmTeW6hCGV4",
    authDomain: "analysis-2b010.firebaseapp.com",
    projectId: "analysis-2b010",
    storageBucket: "analysis-2b010.appspot.com",
    messagingSenderId: "700504174166",
    appId: "1:700504174166:web:4bc79f44bbc6a2a0b015f7",
    measurementId: "G-E4HZVPHWZC"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let editId = null;

  // --- –§—É–Ω–∫—Ü–∏–∏ ---
  function clearForm(){
    ["eventName","targetAudience","growthZones","comment","participant"].forEach(id=>{
      document.getElementById(id).value = "";
    });
    editId = null;
  }

  function saveData(){
    const record = {
      eventName: document.getElementById("eventName").value.trim(),
      targetAudience: document.getElementById("targetAudience").value.trim(),
      growthZones: document.getElementById("growthZones").value.trim(),
      comment: document.getElementById("comment").value.trim(),
      participant: document.getElementById("participant").value.trim(),
      date: new Date().toISOString().split("T")[0],
      time: new Date().toLocaleTimeString(),
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    if(!record.eventName || !record.participant){ alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!"); return; }

    const action = editId ? db.collection("records").doc(editId).set(record) : db.collection("records").add(record);
    action.then(clearForm).catch(console.error);
  }

  function rowHTML(r){
    return `<tr>
      <td>${r.eventName}</td>
      <td>${r.targetAudience}</td>
      <td>${r.growthZones}</td>
      <td>${r.comment}</td>
      <td>${r.participant}</td>
      <td>
        <button class="edit-btn" data-id="${r.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="delete-btn" data-id="${r.id}">–£–¥–∞–ª–∏—Ç—å</button>
      </td>
    </tr>`;
  }

  function renderTables(records){
    const mainBody = document.querySelector("#mainTable tbody");
    const spoilerBody = document.querySelector("#spoilerTable tbody");
    mainBody.innerHTML = records.length ? rowHTML(records[records.length-1]) : "";
    spoilerBody.innerHTML = records.slice(0,-1).reverse().map(rowHTML).join("");
    renderArchive(records, document.getElementById("archiveDate").value);
  }

  function renderArchive(records, date){
    const tbody = document.querySelector("#archiveTable tbody");
    tbody.innerHTML = records.filter(r=>r.date===date).map(r=>
      `<tr>
        <td>${r.date} ${r.time}</td>
        <td>${r.eventName}</td>
        <td>${r.targetAudience}</td>
        <td>${r.growthZones}</td>
        <td>${r.comment}</td>
        <td>${r.participant}</td>
      </tr>`).join("");
  }

  function fetchArchive(){
    db.collection("records").orderBy("timestamp").get().then(snapshot=>{
      const records = [];
      snapshot.forEach(doc => records.push({...doc.data(), id: doc.id}));
      renderArchive(records, archiveInput.value);
    });
  }

  // --- –°–æ–±—ã—Ç–∏—è ---
  document.getElementById("saveBtn").addEventListener("click", saveData);
  document.getElementById("toggleSpoilerBtn").addEventListener("click", ()=> {
    document.getElementById("spoilerTable").classList.toggle("hidden");
  });

  const archiveInput = document.getElementById("archiveDate");
  archiveInput.value = new Date().toISOString().split("T")[0];
  archiveInput.addEventListener("change", fetchArchive);
  document.getElementById("prevDateBtn").addEventListener("click", ()=>{
    const d=new Date(archiveInput.value); d.setDate(d.getDate()-1);
    archiveInput.value=d.toISOString().split("T")[0]; fetchArchive();
  });
  document.getElementById("nextDateBtn").addEventListener("click", ()=>{
    const d=new Date(archiveInput.value); d.setDate(d.getDate()+1);
    archiveInput.value=d.toISOString().split("T")[0]; fetchArchive();
  });

  document.getElementById("downloadCSVBtn").addEventListener("click", ()=>{
    db.collection("records").orderBy("timestamp").get().then(snapshot=>{
      if(snapshot.empty){alert("–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç!");return;}
      let csv="–î–∞—Ç–∞;–ù–∞–∑–≤–∞–Ω–∏–µ;–¶–ê;–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞;–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π;–£—á–∞—Å—Ç–Ω–∏–∫\n";
      snapshot.forEach(doc=>{
        const r=doc.data();
        csv+=`"${r.date} ${r.time}";"${r.eventName}";"${r.targetAudience}";"${r.growthZones}";"${r.comment}";"${r.participant}"\n`;
      });
      const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="archive.csv";
      link.click();
    });
  });

  // --- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Firestore ---
  db.collection("records").orderBy("timestamp").onSnapshot(snapshot=>{
    const records = [];
    snapshot.forEach(doc=>records.push({...doc.data(), id:doc.id}));
    renderTables(records);
  });

  // --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ ---
  document.addEventListener("click", e=>{
    if(e.target.matches(".edit-btn")){
      const id = e.target.dataset.id;
      db.collection("records").doc(id).get().then(doc=>{
        const r = doc.data();
        ["eventName","targetAudience","growthZones","comment","participant"].forEach(id=>{
          document.getElementById(id).value = r[id];
        });
        editId = id;
      });
    }
    if(e.target.matches(".delete-btn")){
      const id = e.target.dataset.id;
      db.collection("records").doc(id).delete().catch(console.error);
    }
  });

  // --- –í—ã–≥—Ä—É–∑–∫–∞ –≤ Google Sheets ---
  const APPS_SCRIPT_URL = "https://script.google.com/u/0/home/projects/1R2DoHx3Kximf674Hh7et9R0RrL9m3OugJHRGEjHZkIh96kbI_xcDWU37/edit"; // –≤—Å—Ç–∞–≤—å—Ç–µ URL –≤–∞—à–µ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Google Apps Script
  document.getElementById("uploadToSheetsBtn").addEventListener("click", ()=>{
    const rows = [];
    document.querySelectorAll("#mainTable tbody tr, #spoilerTable tbody tr").forEach(tr=>{
      const tds = tr.querySelectorAll("td");
      rows.push({
        eventName: tds[0].innerText,
        targetAudience: tds[1].innerText,
        growthZones: tds[2].innerText,
        comment: tds[3].innerText,
        participant: tds[4].innerText
      });
    });

    fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(rows)
    })
    .then(res => res.json())
    .then(data => alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ Google Sheets!"))
    .catch(err => console.error(err));
  });

});
</script>

</body>
</html>








