<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ—Å–ª—É—à–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ (Firebase)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
h2 { margin-top: 30px; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
th { background: #eaeaea; }
input, textarea { width: 100%; padding: 6px; margin: 4px 0; }
button { padding: 6px 12px; margin-top: 5px; cursor: pointer; }
.container { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.grid { display: flex; gap: 20px; }
.form-section { flex: 1; }
.table-section { flex: 2; }
.spoiler { margin-top: 10px; }
.spoiler button { margin-bottom: 8px; }
.hidden { display: none; }
</style>
</head>
<body>

<div class="grid">
  <div class="container form-section">
    <h1>–§–æ—Ä–º–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</h1>
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—É—á–∞—é—â–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label>
    <input type="text" id="eventName">
    <label>–¶–ê:</label>
    <input type="text" id="targetAudience">
    <label>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:</label>
    <textarea id="growthZones"></textarea>
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="comment"></textarea>
    <label>–£—á–∞—Å—Ç–Ω–∏–∫:</label>
    <input type="text" id="participant">
    <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div class="container table-section">
    <h2>–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
    <table id="mainTable">
      <thead>
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–¶–ê</th>
          <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
          <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="spoiler">
      <button id="toggleSpoilerBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
      <table id="spoilerTable" class="hidden">
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–¶–ê</th>
            <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="container">
  <h2>–ê—Ä—Ö–∏–≤ –∑–∞–ø–∏—Å–µ–π</h2>
  <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
  <input type="date" id="archiveDate">
  <button id="prevDateBtn">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
  <button id="nextDateBtn">–°–ª–µ–¥—É—é—â–∞—è ‚û°</button>
  <button id="downloadCSVBtn">üì• –°–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ (Excel/CSV)</button>

  <table id="archiveTable">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–¶–ê</th>
        <th>–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-firestore-compat.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB5ljqThoa3rS8ZjJD-FpsYjmTeW6hCGV4",
    authDomain: "analysis-2b010.firebaseapp.com",
    projectId: "analysis-2b010",
    storageBucket: "analysis-2b010.appspot.com",
    messagingSenderId: "700504174166",
    appId: "1:700504174166:web:4bc79f44bbc6a2a0b015f7",
    measurementId: "G-E4HZVPHWZC"
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();

  let editId = null;

  // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  function clearForm(){
    document.getElementById("eventName").value = "";
    document.getElementById("targetAudience").value = "";
    document.getElementById("growthZones").value = "";
    document.getElementById("comment").value = "";
    document.getElementById("participant").value = "";
    editId = null;
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  function saveData(){
    const eventName = document.getElementById("eventName").value.trim();
    const targetAudience = document.getElementById("targetAudience").value.trim();
    const growthZones = document.getElementById("growthZones").value.trim();
    const comment = document.getElementById("comment").value.trim();
    const participant = document.getElementById("participant").value.trim();
    if(!eventName || !participant){ alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!"); return; }

    const record = {
      eventName, targetAudience, growthZones, comment, participant,
      date: new Date().toISOString().split("T")[0],
      time: new Date().toLocaleTimeString(),
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    if(editId){
      db.collection("records").doc(editId).set(record).then(clearForm).catch(console.error);
    } else {
      db.collection("records").add(record).then(clearForm).catch(console.error);
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫
  function rowHTML(r){
    return `<tr>
      <td>${r.eventName}</td>
      <td>${r.targetAudience}</td>
      <td>${r.growthZones}</td>
      <td>${r.comment}</td>
      <td>${r.participant}</td>
      <td>
        <button class="edit-btn" data-id="${r.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="delete-btn" data-id="${r.id}">–£–¥–∞–ª–∏—Ç—å</button>
      </td>
    </tr>`;
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü
  function renderTables(records){
    const mainBody = document.querySelector("#mainTable tbody");
    const spoilerBody = document.querySelector("#spoilerTable tbody");
    mainBody.innerHTML = "";
    spoilerBody.innerHTML = "";

    if(records.length){
      mainBody.innerHTML = rowHTML(records[records.length-1]);
      for(let i=records.length-2;i>=0;i--){
        spoilerBody.innerHTML += rowHTML(records[i]);
      }
    }
    renderArchive(records, document.getElementById("archiveDate").value);
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞
  function renderArchive(records, date){
    const tbody = document.querySelector("#archiveTable tbody");
    tbody.innerHTML = "";
    records.filter(r=>r.date===date).forEach(r=>{
      tbody.innerHTML += `<tr>
        <td>${r.date} ${r.time}</td>
        <td>${r.eventName}</td>
        <td>${r.targetAudience}</td>
        <td>${r.growthZones}</td>
        <td>${r.comment}</td>
        <td>${r.participant}</td>
      </tr>`;
    });
  }

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Firestore
  db.collection("records").orderBy("timestamp").onSnapshot(snapshot=>{
    const records = [];
    snapshot.forEach(doc=>records.push({...doc.data(), id:doc.id}));
    renderTables(records);
  });

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ
  document.addEventListener("click", e=>{
    if(e.target.matches(".edit-btn")){
      const id = e.target.dataset.id;
      db.collection("records").doc(id).get().then(doc=>{
        const r = doc.data();
        document.getElementById("eventName").value=r.eventName;
        document.getElementById("targetAudience").value=r.targetAudience;
        document.getElementById("growthZones").value=r.growthZones;
        document.getElementById("comment").value=r.comment;
        document.getElementById("participant").value=r.participant;
        editId=id;
      });
    }
    if(e.target.matches(".delete-btn")){
      const id = e.target.dataset.id;
      db.collection("records").doc(id).delete().catch(console.error);
    }
  });

  // –ö–Ω–æ–ø–∫–∏
  document.getElementById("saveBtn").addEventListener("click", saveData);
  document.getElementById("toggleSpoilerBtn").addEventListener("click", ()=>{
    document.getElementById("spoilerTable").classList.toggle("hidden");
  });

  // –ê—Ä—Ö–∏–≤
  const archiveInput = document.getElementById("archiveDate");
  archiveInput.value = new Date().toISOString().split("T")[0];
  function fetchArchive(){
    db.collection("records").orderBy("timestamp").get().then(snapshot=>{
      const records=[];
      snapshot.forEach(doc=>records.push({...doc.data(), id:doc.id}));
      renderArchive(records, archiveInput.value);
    });
  }
  archiveInput.addEventListener("change", fetchArchive);
  document.getElementById("prevDateBtn").addEventListener("click", ()=>{
    const d = new Date(archiveInput.value); d.setDate(d.getDate()-1);
    archiveInput.value=d.toISOString().split("T")[0]; fetchArchive();
  });
  document.getElementById("nextDateBtn").addEventListener("click", ()=>{
    const d = new Date(archiveInput.value); d.setDate(d.getDate()+1);
    archiveInput.value=d.toISOString().split("T")[0]; fetchArchive();
  });

  // CSV
  document.getElementById("downloadCSVBtn").addEventListener("click", ()=>{
    db.collection("records").orderBy("timestamp").get().then(snapshot=>{
      if(snapshot.empty){alert("–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç!");return;}
      let csv="–î–∞—Ç–∞;–ù–∞–∑–≤–∞–Ω–∏–µ;–¶–ê;–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞;–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π;–£—á–∞—Å—Ç–Ω–∏–∫\n";
      snapshot.forEach(doc=>{
        const r = doc.data();
        csv+=`"${r.date} ${r.time}";"${r.eventName}";"${r.targetAudience}";"${r.growthZones}";"${r.comment}";"${r.participant}"\n`;
      });
      const BOM="\uFEFF";
      const blob=new Blob([BOM+csv],{type:"text/csv;charset=utf-8;"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download="archive.csv";
      link.click();
    });
  });
});
</script>

</body>
</html>






